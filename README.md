# Intent

Intent is a small, boring tool that keeps project config in sync by generating tool-owned files from a single `intent.toml`.

Detailed docs: [`documentation.md`](documentation.md)

## Who it's for

*   **Teams** that want one source of truth for Python versions and common commands.
*   **Projects** that want safe, repeatable generation of CI workflows and Justfiles.

## Files

*   **You edit:** `intent.toml`
*   **Intent reads:** `intent.toml`, `pyproject.toml`
*   **Intent writes:** tool-owned files only
*   **Example generated files:** `.github/workflows/ci.yml`, `justfile`

## Installations
### From PyPI

```bash
python -m pip install intent
```

### From source

```bash
python -m pip install -e .
```

## Configuration
### Intent file(intent.toml)
The only file you author
```toml
[intent]
schema_version = 1

# use to verify that versions conform all around
[python]
version = "3.12"

[commands]
test = "pytest -q"
lint = "ruff check ."

# used to generate and install dependencies in ci.yml
[ci]
install = "-e .[dev]"
python_versions = ["3.11", "3.12"]
triggers = ["push", "pull_request"]
# This value is used verbatim when generating CI install steps.
# Intent does not infer dependencies, it only reflects what you declare.
# Optional: when set, CI runs a matrix across these Python versions.
# Optional: when set, CI uses these workflow triggers (default: ["push"]).

[policy]
strict = false
# If true, `intent check` behaves like `intent check --strict` by default.
# You can still override per-run with `--strict` / `--no-strict`.
```

This file describes **agreements**, not implementations.
If something is not declared in `intent.toml`, Intent will not guess.


---

### Canonical Files (Read-Only)

Some files are owned by the ecosystem, not by Intent.

Examples:

* `pyproject.toml`

Intent will:

* read them
* validate consistency
* fail loudly on mismatch

Intent will not modify them during `sync`/`check`.
`intent reconcile --apply --allow-existing` can update version fields by explicit opt-in.

---

### Example
### ✅ Python version consistency

```bash
intent sync
```
will:
* Read `requires-python` from `pyproject.toml`
* Validate it against the `intent.toml` python declared version and return one of the following:

  * pyproject requires_python matches intent
  * Version mismatch (simple spec): intent=X.Y vs pyproject=A.B
  * Version ok (range): intent X.Y satisfies SPEC
  * Unsupported requires_python spec (only for invalid spec strings)

Intent uses `packaging` for `requires-python` evaluation, so common specifiers like
`~=`, `==`, `!=`, `<=`, `>=`, and range combinations are supported.

---

### Generated Files (Tool-Owned)

Intent generates files it fully owns:

* `.github/workflows/ci.yml`
* `justfile`

These files:

* contain a `# GENERATED BY intent` marker
* are written atomically
* are overwritten safely
* refuse overwrite if user-edited

## Usage & Commands

All commands and what they do:

| Command | What it does |
| --- | --- |
| `intent --version` | Show version and exit. |
| `intent init` | Create a starter `intent.toml`. |
| `intent init --from-existing` | Create `intent.toml` and infer python version from `pyproject.toml` when possible. |
| `intent init --force` | Overwrite existing `intent.toml`. |
| `intent show` | Show resolved config and environment inspection summary. |
| `intent show --format json` | Show resolved config as JSON for automation/scripts. |
| `intent sync` | Read `intent.toml` + `pyproject.toml` and show config + version check. |
| `intent sync --show-ci` | `intent sync` plus preview generated CI. |
| `intent sync --show-just` | `intent sync` plus preview generated justfile. |
| `intent sync --dry-run` | Preview what would be written (no writes). |
| `intent sync --write` | Write tool-owned files. |
| `intent check` | Check drift without writing. |
| `intent check --strict` | Check drift with strict `requires_python` parsing. |
| `intent check --no-strict` | Override config policy and run non-strict checks. |
| `intent check --format json` | Check drift and emit machine-readable JSON. |
| `intent reconcile --plan` | Preview Python-version reconciliation across `pyproject.toml`, `.python-version`, and `.tool-versions`. |
| `intent reconcile --apply` | Apply reconciliation for missing files; skips existing-file edits unless opted in. |
| `intent reconcile --apply --allow-existing` | Apply reconciliation including edits to existing version files. |
| `intent sync path/to/intent.toml` | Use a non-default config path for sync. |
| `intent check path/to/intent.toml` | Use a non-default config path for check. |

## Notes

Expected output:

| Command | Expected output |
| --- | --- |
| `intent --version` | Prints version like `0.3.0`. |
| `intent init` | Writes `intent.toml` starter template (`python=3.12`, basic commands, CI install). |
| `intent init --from-existing` | Writes template and attempts to infer python version from `pyproject.toml` (`requires-python`). |
| `intent init --force` | Overwrites existing `intent.toml`. |
| `intent show` | Prints schema version, policy strictness, commands, and pyproject status. |
| `intent show --format json` | Outputs machine-readable config summary and pyproject status. |
| `intent sync` | Lines like `Intent python version: 3.12`, `Intent commands:`, `test -> pytest -q`, `Version ok (range): intent 3.12 satisfies >=3.10,<3.13`. |
| `intent sync --show-ci` | Same as `intent sync`, then `--- ci.yml (preview) ---` and rendered `ci.yml`. |
| `intent sync --show-just` | Same as `intent sync`, then `--- justfile (preview) ---` and rendered `justfile`. |
| `intent sync --dry-run` | `--- dry-run ---`, then `Would write .github/workflows/ci.yml` and `Would update justfile` (or `No changes to ...`). If a file exists but is not tool-owned, shows `Cannot update ... not tool-owned`. |
| `intent sync --write` | `Wrote .github/workflows/ci.yml` and `Wrote justfile` (or `No changes to ...`). |
| `intent check` | `✓ Version ok (range): ...`, `✓ .github/workflows/ci.yml is up to date`, `✓ justfile is up to date`. |
| `intent check --strict` | Same as `intent check`, but unsupported specs are errors. |
| `intent check --no-strict` | Forces non-strict behavior even when `[policy].strict = true`. |
| `intent check --format json` | JSON object with `ok`, `versions`, and per-file drift status. Exit codes stay the same (`0/1/2`). |
| `intent reconcile --plan` | Prints a no-write plan showing `aligned`/`drift`/`missing` status and recommended actions for Python version files. |
| `intent reconcile --apply` | Writes missing version files and reports skipped existing-file drifts (exit `1` when skips remain). |
| `intent reconcile --apply --allow-existing` | Updates existing `pyproject.toml`, `.python-version`, and `.tool-versions` Python version entries. |
| `intent sync path/to/intent.toml` | Same outputs as `intent sync`, using that file. |
| `intent check path/to/intent.toml` | Same outputs as `intent check`, using that file. |

### Stable Error Codes

Intent emits stable error codes in text output (for failures) and JSON output (`--format json`):

| Code | Meaning |
| --- | --- |
| `INTENT001` | Invalid CLI option combination (`sync --write --dry-run`). |
| `INTENT002` | Missing intent config file. |
| `INTENT003` | Invalid intent config content. |
| `INTENT004` | Ownership violation while writing generated files. |
| `INTENT005` | `intent init` refused to overwrite existing file (use `--force`). |
| `INTENT101` | Python version compatibility/spec check failure. |
| `INTENT201` | Required generated file is missing. |
| `INTENT202` | Generated file exists but is not tool-owned. |
| `INTENT203` | Generated file is out of date. |

### Config Schema

Intent supports config schema:

| Field | Meaning |
| --- | --- |
| `[intent].schema_version = 1` | Current supported schema version. |
| `[policy].strict = true/false` | Default strictness for `intent check` when no strict flag is passed. |
| `[ci].python_versions = ["3.11", "3.12"]` | Optional CI matrix versions. If omitted, CI uses `[python].version`. |
| `[ci].triggers = ["push", "pull_request"]` | Optional CI workflow triggers. If omitted, CI defaults to `["push"]`. |

## Bootstrapping (`intent init`)

Create a new `intent.toml`:

```bash
intent init
```

Infer Python version from existing `pyproject.toml` (when possible):

```bash
intent init --from-existing
```

Overwrite an existing `intent.toml`:

```bash
intent init --force
```

## Pre-commit Integration

Use `pre-commit` to block commits when Intent drift exists.

Install:

```bash
python -m pip install pre-commit
```

Add this to `.pre-commit-config.yaml`:

```yaml
repos:
  - repo: local
    hooks:
      - id: intent-check
        name: intent check
        entry: intent check --strict
        language: system
        pass_filenames: false
```

Enable hooks:

```bash
pre-commit install
```

Run once across all files:

```bash
pre-commit run --all-files
```

Expected behavior:
- commit is blocked when `intent check --strict` exits non-zero
- output includes stable error codes (for example `INTENT101`, `INTENT201`)

## Safety & Ownership Rules
Intent is intentionally conservative.

* Intent **never edits user-owned files**.
* Intent **refuses to overwrite files** unless they contain a generated marker.
* All generated files are clearly marked as **tool-owned**.
* Output is **deterministic and idempotent**:
  running the same command twice produces no changes.
* File writes are **atomic**:
  files are written via a temporary file and replaced safely.

If a file exists but is not marked as tool-owned, Intent will fail loudly instead of guessing.

---

## Non-Goals

Intent does **not**:

* Edit existing CI workflows
* Merge or patch user files
* Guess dependencies
* Perform bidirectional sync

When in doubt, Intent refuses to act.

---

## License

MIT
